<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Big Data Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Big data 処理に関する製品のサポート情報のブログです。</subtitle>
  <link href="https://jpaz-bigdata.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaz-bigdata.github.io/blog/"/>
  <updated>2025-01-30T09:32:33.085Z</updated>
  <id>https://jpaz-bigdata.github.io/blog/</id>
  
  <author>
    <name>Azure Big Data Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GraphAPI を用いて SharePoint Online からファイルを移行する</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-connect-sp-online-by-graphapi/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-connect-sp-online-by-graphapi/</id>
    <published>2025-01-30T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.085Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Data Factory では、SharePoint Online リストや ファイルをコピーすることが可能です。<br>詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/connector-sharepoint-online-list?tabs=data-factory">SharePoint コネクタ</a> の公式ドキュメントをご覧ください。  </p><p>しかし、上記ドキュメントにて利用されている <strong>ACS の提供終了計画</strong> により、2026 年 4 月以降はご利用できません。<br>SharePoint Online リストのデータを取得する場合は、<strong>サービスプリンシパル証明書認証</strong> を代替策としてご利用いただけます。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-1.png">    </p><p>SharePoint Online 上のファイルをコピーする方法として、Microsoft Graph REST API を用いて方法がございます。本記事では、Graph API を用いて SharePoint Online 上のファイルを Azure Data Lake Storage Gen2 へコピーする方法をご紹介いたします。　　</p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2 </li><li>ユーザー割り当てマネージド ID</li><li>Microsoft Graph REST API</li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="認証の準備"><a href="#認証の準備" class="headerlink" title="認証の準備"></a>認証の準備</h2><h3 id="ユーザー割り当てマネージド-ID-の作成"><a href="#ユーザー割り当てマネージド-ID-の作成" class="headerlink" title="ユーザー割り当てマネージド ID の作成"></a>ユーザー割り当てマネージド ID の作成</h3><p>本記事では、Microsoft Graph REST API を利用する際の資格情報として、ユーザー割り当てマネージド IDを利用します。<br>ユーザー割り当てマネージド ID を作成していない場合は、以下のように Azure ポータル上から作成可能です。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-2.png"></p><h3 id="ユーザー割り当てマネージド-ID-の-Object-ID-の確認"><a href="#ユーザー割り当てマネージド-ID-の-Object-ID-の確認" class="headerlink" title="ユーザー割り当てマネージド ID の Object ID の確認"></a>ユーザー割り当てマネージド ID の Object ID の確認</h3><p>作成したユーザー割り当てマネージド ID より、<strong>オブジェクト (プリンシパル) ID</strong> をメモします。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-3.png"></p><h3 id="ユーザー割り当てマネージド-ID-に権限を付与"><a href="#ユーザー割り当てマネージド-ID-に権限を付与" class="headerlink" title="ユーザー割り当てマネージド ID に権限を付与"></a>ユーザー割り当てマネージド ID に権限を付与</h3><p>ユーザー割り当てマネージド ID に対して、SharePoint Online 上のリソースを取得するための権限を付与します。<br>任意の端末から、以下の PowerShell コマンドを実行します。<br>今回は、SharePoint Online サイト上のリソースを読み取り/取得するために <a href="https://learn.microsoft.com/ja-jp/graph/permissions-reference#sitesreadall">Sites.ReadWrite.All</a> 権限を付与しております。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Connect-AzureAD -TenantId &quot;&lt;テナントID&gt;&quot;</span><br><span class="line">$ManagedIdentity = Get-AzureADServicePrincipal -ObjectId &quot;&lt;ユーザー割り当てマネージド ID のオブジェクト (プリンシパル) ID&gt;&quot;</span><br><span class="line">$GraphAPI = Get-AzureADServicePrincipal -Filter &quot;DisplayName eq &#x27;Microsoft Graph&#x27;&quot;</span><br><span class="line">$SitesReadAll = $GraphAPI.AppRoles | where Value -like &#x27;Sites.Read.All&#x27;</span><br><span class="line"></span><br><span class="line">New-AzureADServiceAppRoleAssignment  -Id $SitesReadAll.Id  -ObjectId $ManagedIdentity.ObjectId  -PrincipalId $ManagedIdentity.ObjectId  -ResourceId $GraphAPI.ObjectId</span><br></pre></td></tr></table></figure><p>　　　　</p><h3 id="Azure-Data-Factory-Studio-上でユーザー割り当てマネージド-ID-の登録"><a href="#Azure-Data-Factory-Studio-上でユーザー割り当てマネージド-ID-の登録" class="headerlink" title="Azure Data Factory Studio 上でユーザー割り当てマネージド ID の登録"></a>Azure Data Factory Studio 上でユーザー割り当てマネージド ID の登録</h3><p>Azure Data Factory 上で、権限を付与したユーザー割り当てマネージド ID が利用できるように登録を行います。<br><a href="https://adf.azure.com/">Azure Data Factory Studio</a> を開いていただき、[管理] &gt; [資格情報] &gt; [+ 新規] から作成いたします。設定する項目は以下の通りです。<br>|  項目  |  値  |<br>| —- | —- |<br>|  種類  |  User-assigned managed identity  |<br>|  Azure サブスクリプション  |  作成したユーザー割り当てマネージド ID を選択します  |<br>|  ユーザー割り当てマネージド ID  | 作成したユーザー割り当てマネージド ID を選択します  |</p><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-4.png"></p><h2 id="パイプラインを作成する"><a href="#パイプラインを作成する" class="headerlink" title="パイプラインを作成する"></a>パイプラインを作成する</h2><p>Microsoft Graph REST API を使用して、コピーに必要な ダウンロード URL を取得するための Web アクティビティと コピー アクティビティを作成します。<br>パイプラインの全体図は以下の通りです。</p><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-5.png"></p><p>今回のパイプラインでは、対象の SharePoint Online のドキュメント フォルダ配下にある input.xlsx ファイルを対象とします。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-6.png"></p><h3 id="Get-SiteID-Web-アクティビティ"><a href="#Get-SiteID-Web-アクティビティ" class="headerlink" title="Get SiteID Web アクティビティ"></a>Get SiteID Web アクティビティ</h3><p>接続したい SharePoint Online サイトの サイト ID を取得します。<br><a href="https://learn.microsoft.com/ja-jp/graph/api/site-get?view=graph-rest-1.0&tabs=http#example-2-get-a-site-by-server-relative-url">サイト リソースを取得する</a> を参考に、Web アクティビティでは以下のように設定します。</p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>URL</td><td><a href="https://graph.microsoft.com/v1.0/sites/">https://graph.microsoft.com/v1.0/sites/</a>&lt;SharePoint Online のドメイン名&gt;.sharepoint.com:/sites/&lt;サイト名&gt;</td></tr><tr><td>メソッド</td><td>GET</td></tr><tr><td>認証</td><td><a href="https://graph.microsoft.com/">https://graph.microsoft.com</a></td></tr><tr><td>リソース</td><td>ユーザー割り当てマネージド ID</td></tr><tr><td>資格情報</td><td>Azure Data Factory Studio で登録したユーザー割り当てマネージド ID の資格情報</td></tr></tbody></table><p>Web アクティビティの実行出力より、<strong>id</strong> が取得できていることを確認します。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-7.png">　　</p><h3 id="Get-DriveID-Web-アクティビティ"><a href="#Get-DriveID-Web-アクティビティ" class="headerlink" title="Get DriveID Web アクティビティ"></a>Get DriveID Web アクティビティ</h3><p>接続したい SharePoint Online サイトに紐づく Drive ID を取得します。<br><a href="https://learn.microsoft.com/ja-jp/graph/api/drive-list?view=graph-rest-1.0&tabs=http#list-a-sites-drives">サイトのドライブを一覧表示する</a> を参考に、Web アクティビティでは以下のように設定します。</p><p>先ほど取得したサイト ID を利用するため、URL には以下のように Get SiteID Web アクティビティの出力を利用するように記載します。Web アクティビティ名が異なる場合は、アクティビティ名と揃えてください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@concat(&#x27;https://graph.microsoft.com/v1.0/sites/&#x27;</span><br><span class="line">    ,activity(&#x27;Get SiteID&#x27;).output.id</span><br><span class="line">    ,&#x27;/drives&#x27;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>URL</td><td>[動的なコンテンツを追加] より、上記を記載</td></tr><tr><td>メソッド</td><td>GET</td></tr><tr><td>認証</td><td><a href="https://graph.microsoft.com/">https://graph.microsoft.com</a></td></tr><tr><td>リソース</td><td>ユーザー割り当てマネージド ID</td></tr><tr><td>資格情報</td><td>Azure Data Factory Studio で登録したユーザー割り当てマネージド ID の資格情報</td></tr></tbody></table><p>Web アクティビティの実行出力より、<strong>value 配列</strong> が取得できていることを確認します。こちらの配列の中から、必要な要素をフィルターします。<br><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-8.png"></p><h3 id="Filter1-Fileter-アクティビティ"><a href="#Filter1-Fileter-アクティビティ" class="headerlink" title="Filter1 Fileter アクティビティ"></a>Filter1 Fileter アクティビティ</h3><p>必要な Document ドライブの情報のみを抽出します。以下の通り、設定します。<br>こちらも前のアクティビティの出力結果を利用しますので、必要に応じてアクティビティ名を修正してください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">項目</span><br><span class="line">@activity(&#x27;Get DriveID&#x27;).output.value</span><br><span class="line"></span><br><span class="line">条件</span><br><span class="line">@equals(item().name,&#x27;Documents&#x27;)</span><br></pre></td></tr></table></figure><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>項目</td><td>[動的なコンテンツを追加] より、上記を記載</td></tr><tr><td>条件</td><td>[動的なコンテンツを追加] より、上記を記載</td></tr></tbody></table><h3 id="Get-File-Web-アクティビティ"><a href="#Get-File-Web-アクティビティ" class="headerlink" title="Get File Web アクティビティ"></a>Get File Web アクティビティ</h3><p>取得したいファイルの ダウンロード URL を取得します。  </p><p>今回は、<code>input.xlsx</code> を取得するため <code>/root:/input.xlsx</code> と記載しております。<br><code>test</code> フォルダ配下にある場合は、<code>/root:/test/input.xlsx</code> のように指定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@concat(</span><br><span class="line">    &#x27;https://graph.microsoft.com/v1.0/sites/&#x27;</span><br><span class="line">    ,activity(&#x27;Get SiteID&#x27;).output.id</span><br><span class="line">    ,&#x27;/drives/&#x27;</span><br><span class="line">    ,activity(&#x27;Filter1&#x27;).output.value[0].id</span><br><span class="line">    ,&#x27;/root:/input.xlsx&#x27;    </span><br><span class="line">)</span><br></pre></td></tr></table></figure><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>URL</td><td>[動的なコンテンツを追加] より、上記を記載</td></tr><tr><td>メソッド</td><td>GET</td></tr><tr><td>認証</td><td><a href="https://graph.microsoft.com/">https://graph.microsoft.com</a></td></tr><tr><td>リソース</td><td>ユーザー割り当てマネージド ID</td></tr><tr><td>資格情報</td><td>Azure Data Factory Studio で登録したユーザー割り当てマネージド ID の資格情報</td></tr></tbody></table><p>Web アクティビティの実行出力より、**@microsoft.graph.downloadUrl** が取得できていることを確認します。</p><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-9.png"></p><h3 id="Copy-アクティビティ"><a href="#Copy-アクティビティ" class="headerlink" title="Copy アクティビティ"></a>Copy アクティビティ</h3><p>Get File Web アクティビティで得られた <code>@microsoft.graph.downloadUrl</code> を接続先として、コピー アクティビティを作成します。<br>ソースは、HTTP コネクタを利用しますが、以下の画像のように [ベース URL] は動的に変化するため、パラメーター化しておきます。</p><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-10.png">  </p><p>同様に、データセットの作成画面では、リンク サービスのパラメーターを埋める UI が表示されますが、パイプライン編集画面から指定するために、　　<br>データセットのパラメーターを [パラメーター] タブより作成しておき、データセットのパラメーターを指定します。</p><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-11.png"></p><p>パイプラインの編集画面にて、[ソース] &gt; [ソース データセット] &gt; [データセットのプロパティ] が表示されますので、以下のように <code>@microsoft.graph.downloadUrl</code> を指定します。</p><pre><code>@activity(&#39;Get File&#39;).output[&#39;@microsoft.graph.downloadUrl&#39;]</code></pre><p><img src="/blog/DataFactory/how-to-connect-sp-online-by-graphapi/how-to-connect-sp-online-by-graphapi-12.png"></p><p>設定は以上となります。　　</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure Data Factory では、SharePoint Online リストや ファイルをコピーすることが可能です。&lt;br&gt;詳細は、&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/data-factory/conn</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="SharePoint" scheme="https://jpaz-bigdata.github.io/blog/tags/SharePoint/"/>
    
    <category term="GraphAPI" scheme="https://jpaz-bigdata.github.io/blog/tags/GraphAPI/"/>
    
  </entry>
  
  <entry>
    <title>カスタム ロールによる ADF の操作制御</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-custom-roles/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-custom-roles/</id>
    <published>2024-12-26T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.099Z</updated>
    
    <content type="html"><![CDATA[<p>この記事では、カスタム ロール を使用して Azure Data Factory Studio におけるユーザーの操作 (データのプレビュー、パイプラインの作成、リンク サービスの作成) に制限を加える方法について説明します。  </p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2  </li></ul><h1 id="Azure-のロール"><a href="#Azure-のロール" class="headerlink" title="Azure のロール"></a>Azure のロール</h1><h2 id="カスタム-ロールの作成方法"><a href="#カスタム-ロールの作成方法" class="headerlink" title="カスタム ロールの作成方法"></a>カスタム ロールの作成方法</h2><p>Azure では、組み込みで提供されているロールの他に、ユーザーで独自のカスタム ロールを作成することが可能です。<br>組み込みロールと同様に、カスタム ロールは、ユーザー、グループ、サービス プリンシパルに対して、管理グループ、サブスクリプション、およびリソース グループのスコープで割り当てることができます。</p><p>カスタム ロールの作成手順につきましては、公式ドキュメントの <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">Azure portal を使用して Azure カスタム ロールを作成または更新する</a> をご覧ください。</p><h2 id="Azure-Data-Factory-の組み込みロール"><a href="#Azure-Data-Factory-の組み込みロール" class="headerlink" title="Azure Data Factory の組み込みロール"></a>Azure Data Factory の組み込みロール</h2><p>Azure Data Factory の組み込みロールとして、<strong>「Data Factory 共同作成者」</strong> ロールが提供されています。<br><strong>「Data Factory 共同作成者」</strong> ロールで提供されている各権限につきましては、 <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#data-factory-contributor">Azure 組み込みロール - Data Factory Contributor</a> および <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/permissions/analytics#microsoftdatafactory">Microsoft.DataFactory</a> ドキュメントをご覧ください。<br>なお、上記のドキュメントにて 「Microsoft.DataFactory/dataFactories/*」 は、既に廃止されている Azure Data Factory V1 向けになりますので、カスタム ロールを作成される際は考慮していただく必要はございません。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-7.png">  </p><h1 id="カスタム-ロールによる制限のシナリオ"><a href="#カスタム-ロールによる制限のシナリオ" class="headerlink" title="カスタム ロールによる制限のシナリオ"></a>カスタム ロールによる制限のシナリオ</h1><p>以下に、よくある利用例としてのカスタム ロールをご紹介いたします。<br>組み込みロールである <strong>「Data Factory 共同作成者」</strong> ロールを基本に、制限したいアクションに該当する権限を <strong>NotAction</strong> に追加いたします。<br>作成後、制限したいユーザーにカスタム ロールを付与します。なお、反映までに数分かかる場合がございます。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-1.png"><br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-2.png">  </p><p>また、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/concepts-roles-permissions#custom-scenarios-and-custom-roles">Azure Data Factory のロールとアクセス許可</a> ドキュメントも併せてご覧ください。</p><h2 id="データのプレビューを制限する"><a href="#データのプレビューを制限する" class="headerlink" title="データのプレビューを制限する"></a>データのプレビューを制限する</h2><p>既存のパイプラインに設定されているアクティビティでは、[データのプレビュー] を押下することで、<br>接続先のデータを確認することが可能です。<br>こちらの操作をユーザーに操作させたくない場合は、以下の 3 つの権限を NotActions に追加します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;notActions&quot;: [</span><br><span class="line">                    &quot;Microsoft.DataFactory/factories/getFeatureValue/read&quot;,</span><br><span class="line">                    &quot;Microsoft.DataFactory/factories/getDataPlaneAccess/action&quot;,</span><br><span class="line">                    &quot;Microsoft.DataFactory/factories/addDataFlowToDebugSession/action&quot;</span><br><span class="line">                ],</span><br></pre></td></tr></table></figure><p>上記のカスタム ロールを付与されたユーザーが、[データのプレビュー] を押下すると、　　<br>以下のような権限が不足しているエラーを確認することが可能です。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-3.png">  </p><p>データ フローの [データのプレビュー] でも同様のエラーをご確認いただけます。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-4.png">  </p><h2 id="パイプラインの新規作成および制限を制限する"><a href="#パイプラインの新規作成および制限を制限する" class="headerlink" title="パイプラインの新規作成および制限を制限する"></a>パイプラインの新規作成および制限を制限する</h2><p>既存のパイプラインの編集や新規のパイプラインの作成を制限されたい場合は、以下の権限を NotActions に追加いたします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;notActions&quot;: [</span><br><span class="line">                    &quot;Microsoft.DataFactory/factories/pipelines/write&quot;</span><br><span class="line">                ]</span><br></pre></td></tr></table></figure><p>以下のように、操作を行う権限が不足しているエラーを確認できます。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-5.png">  </p><h2 id="リンク-サービスの新規作成および編集を制限する"><a href="#リンク-サービスの新規作成および編集を制限する" class="headerlink" title="リンク サービスの新規作成および編集を制限する"></a>リンク サービスの新規作成および編集を制限する</h2><p>既存のリンク サービスの編集や新規のリンク サービスの作成を制限されたい場合は、以下の権限を NotActions に追加いたします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;notActions&quot;: [</span><br><span class="line">                    &quot;Microsoft.DataFactory/factories/linkedServices/write&quot;</span><br><span class="line">                ]</span><br></pre></td></tr></table></figure><p>以下のように、操作を行う権限が不足しているエラーを確認できます。<br><img src="/blog/DataFactory/how-to-custom-roles/how-to-custom-roles-6.png">  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;この記事では、カスタム ロール を使用して Azure Data Factory Studio におけるユーザーの操作 (データのプレビュー、パイプラインの作成、リンク サービスの作成) に制限を加える方法について説明します。  &lt;/p&gt;
&lt;h1 id=&quot;検証環境&quot;&gt;&lt;a </summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions へのシステム割り当てマネージド ID 認証の設定方法</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-use-sami-auth4functions/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-use-sami-auth4functions/</id>
    <published>2024-07-12T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.110Z</updated>
    
    <content type="html"><![CDATA[<p>この記事では、システム割り当てマネージド ID を使用して Azure Data Factory から Azure 関数を呼び出す方法について説明します。</p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2</li><li>Azure Functions </li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="手順-1-アプリケーションの登録および設定を行う"><a href="#手順-1-アプリケーションの登録および設定を行う" class="headerlink" title="手順 1 アプリケーションの登録および設定を行う"></a>手順 1 アプリケーションの登録および設定を行う</h2><h3 id="手順-1-1-未作成の場合-アプリケーションの登録を行う"><a href="#手順-1-1-未作成の場合-アプリケーションの登録を行う" class="headerlink" title="手順 1.1 (未作成の場合) アプリケーションの登録を行う"></a>手順 1.1 (未作成の場合) アプリケーションの登録を行う</h3><p>Azure ポータルにて、[Microsoft Entra ID] と検索いただき、<br>[+ 追加] &gt; [アプリの登録] よりアプリの作成を行います。<br>名前を記載いただき、特別な理由がなければ規定値のまま進めます。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-0.png"><br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-1.png"></p><p>作成後に表示される「アプリケーション (クライアント) ID」をメモします。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-2.png"></p><h3 id="手順-1-2-アプリケーションのロールを作成する"><a href="#手順-1-2-アプリケーションのロールを作成する" class="headerlink" title="手順 1.2 アプリケーションのロールを作成する"></a>手順 1.2 アプリケーションのロールを作成する</h3><p>Azure ポータルにて [アプリの登録] を開きます。<br>[アプリ ロール] &gt; [アプリ ロールの作成] を押下いただき、新規にロールを作成いたします。  </p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>表示名</td><td>ご自由に設定ください</td></tr><tr><td>許可されたメンバーの種類</td><td>アプリケーション</td></tr><tr><td>値</td><td>ご自由に設定いただけますが、後ほど使用します</td></tr><tr><td>説明</td><td>ご自由に設定ください</td></tr></tbody></table><p><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-3.png"></p><h3 id="手順-1-3-マネージド-ID-にアプリ-ロールを付与する"><a href="#手順-1-3-マネージド-ID-にアプリ-ロールを付与する" class="headerlink" title="手順 1.3 マネージド ID にアプリ ロールを付与する"></a>手順 1.3 マネージド ID にアプリ ロールを付与する</h3><p>事前に権限を割り振れるかどうか確認いたします。<br>[エンタープライズ アプリケーション] より、該当のアプリケーションを選択ください。<br>[プロパティ] より、「割り当てが必要ですか?」が有効になっていることを確認します。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-4.png"></p><p>その後、Azure Cloud Shell や PowerShell を用いて以下のコマンドを実行いたします。<br>AzureAD モジュールを用いるサンプル プログラムを記載しておりますが、<a href="https://learn.microsoft.com/ja-jp/powershell/azure/active-directory/install-adv2?view=azureadps-2.0">AzureAD モジュール 公式ドキュメント</a> にて、2024 年 3 月 30 日をもって、非推奨プランとなっている点にご留意ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Connect-AzureAD</span><br><span class="line">$MSI = Get-AzureADServicePrincipal -Filter &quot;displayName eq &#x27;&lt;datafactory-name&gt;&#x27;&quot; </span><br><span class="line">$funapp = Get-AzureADServicePrincipal -Filter &quot;displayName eq &#x27;&lt;aad-appName&gt;&#x27;&quot;</span><br><span class="line">$PermissionName = &quot;&lt;手順1.2 で設定した「値」を記載ください。&gt;&quot;　</span><br><span class="line">$approle = $funapp.AppRoles | Where-Object &#123;$_.Value -eq $PermissionName&#125;</span><br><span class="line">New-AzureADServiceAppRoleAssignment -ObjectId $MSI.ObjectId -PrincipalId $MSI.ObjectId -ResourceId $funapp.ObjectId -Id $approle.Id</span><br></pre></td></tr></table></figure><p>AzureAD モジュールがご要望に沿わない場合は、後続モジュールである Microsoft Graph PowerShell をご利用ください。<br>こちらの場合は、以下のようなサンプル プログラムとなります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Connect-MgGraph -Scopes &#x27;AppRoleAssignment.ReadWrite.All&#x27;</span><br><span class="line">$MSI = Get-MgServicePrincipal -Filter &quot;displayName eq &#x27;&lt;datafactory-name&gt;&#x27;&quot;</span><br><span class="line">$funapp = Get-MgServicePrincipal -Filter &quot;displayName eq &#x27;&lt;aad-appName&gt;&#x27;&quot;</span><br><span class="line">$PermissionName = &quot;&lt;手順1.2 で設定した「値」を記載ください。&gt;&quot;　</span><br><span class="line">$approle = $funapp.AppRoles | Where-Object &#123;$_.Value -eq $PermissionName&#125;</span><br><span class="line"> </span><br><span class="line">$params = @&#123;</span><br><span class="line">principalId = $MSI.Id</span><br><span class="line">resourceId = $funapp.Id</span><br><span class="line">appRoleId = $approle.Id</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">New-MgServicePrincipalAppRoleAssignment -ServicePrincipalId $MSI.Id -BodyParameter $params</span><br></pre></td></tr></table></figure><h3 id="手順-1-4-ロールの割り当てを確認する"><a href="#手順-1-4-ロールの割り当てを確認する" class="headerlink" title="手順 1.4 ロールの割り当てを確認する"></a>手順 1.4 ロールの割り当てを確認する</h3><p>[エンタープライズ アプリケーション] より、該当のアプリケーションを選択ください。<br>[ユーザーとグループ] より、ご利用の Azure Data Factory 名で追加されているかご確認ください。<br><a href="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-5.png"></a></p><h2 id="手順-2-Azure-関数の認証設定を行う"><a href="#手順-2-Azure-関数の認証設定を行う" class="headerlink" title="手順 2 Azure 関数の認証設定を行う"></a>手順 2 Azure 関数の認証設定を行う</h2><h3 id="手順-2-1-認証にてアプリケーションを追加する"><a href="#手順-2-1-認証にてアプリケーションを追加する" class="headerlink" title="手順 2.1 認証にてアプリケーションを追加する"></a>手順 2.1 認証にてアプリケーションを追加する</h3><p>ご利用の Azure 関数の [認証] &gt; [ID プロバイダーを追加] を開きます。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-6.png"></p><p>以下画像のように設定いたします。<br>特筆すべき点を以下の表に記載しております。  </p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>ID プロバイダー</td><td>Microsoft</td></tr><tr><td>アプリの登録</td><td>既存アプリの登録の詳細を提供します</td></tr><tr><td>アプリケーション (クライアント) ID</td><td>2.1 で作成したアプリのアプリケーション (クライアント) ID</td></tr><tr><td>クライアント アプリケーションの要件</td><td>「このアプリケーション自体からの要求のみを許可する」もしくは 「特定のクライアント アプリケーションからの要求を許可する」</td></tr><tr><td>許可されたクライアント アプリケーション (特定のクライアント アプリケーションからの要求を許可する を選択した場合)</td><td>Azure Data Factory のマネージド ID の<strong>アプリケーション (クライアント) ID</strong></td></tr><tr><td>認証されていない要求</td><td>HTTP 401 認可されていない: API に推奨</td></tr></tbody></table><p><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-9.png"></p><p>なお、Azure Data Factory のマネージド ID のアプリケーション (クライアント) ID は、以下にてご確認いただけます。  </p><p>Azure ポータルより「Microsoft Entra ID」と検索いただき、<br>検索ボックスにて、ご利用の Azure Data Factory 名を検索いたします。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-10.png"></p><p>該当の Azure Data Factory をクリックいただくことで、「アプリケーション ID」をご確認いただけます。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-11.png"></p><h2 id="手順-3-Azure-Data-Factory-の-Azure-関数-アクティビティの設定"><a href="#手順-3-Azure-Data-Factory-の-Azure-関数-アクティビティの設定" class="headerlink" title="手順 3 Azure Data Factory の Azure 関数 アクティビティの設定"></a>手順 3 Azure Data Factory の Azure 関数 アクティビティの設定</h2><p>Azure Data Factory Studio を開き、Azure 関数 アクティビティの設定を行います。<br>Azure 関数アクティビティをドラッグアンドドロップした後、[設定] &gt; [Azure 関数のリンク サービス] &gt; [+ 新規] を選択します。<br><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-7.png">  </p><p>接続先の関数アプリを選択いただき、[認証方法] を「システム割り当てマネージド ID」を選択し、[リソース ID] には手順 2.1 および手順 2.2 で登録したアプリケーションのクライアント ID を設定します。<br>詳細な設定項目につきましては、公式ドキュメントの <a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-azure-function-activity#azure-function-linked-service">Azure Functions のリンクされたサービス</a> もご覧ください。</p><p><img src="/blog/DataFactory/how-to-use-sami-auth4functions/how-to-use-sami-auth4functions-8.png">  </p><p>以上の設定で完了です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;この記事では、システム割り当てマネージド ID を使用して Azure Data Factory から Azure 関数を呼び出す方法について説明します。&lt;/p&gt;
&lt;h1 id=&quot;検証環境&quot;&gt;&lt;a href=&quot;#検証環境&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="Azure Functions" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure-Functions/"/>
    
    <category term="システム割り当てマネージドID" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89ID/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions へのシステム割り当てマネージド ID 認証の設定方法 (ユーザー割り当てマネージド ID を用いる方法)</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-use-usai-auth4functions/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-use-usai-auth4functions/</id>
    <published>2024-05-30T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.113Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83">検証環境</a></li><li><a href="#%E6%89%8B%E9%A0%86">手順</a><ul><li><a href="#%E6%89%8B%E9%A0%86-1-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%82%92%E8%A8%AD%E5%AE%9A">手順 1 ユーザー割り当てマネージド ID を設定</a></li><li><a href="#%E6%89%8B%E9%A0%86-2-azure-%E9%96%A2%E6%95%B0%E3%81%AE%E8%AA%8D%E8%A8%BC%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A1%8C%E3%81%86">手順 2 Azure 関数の認証設定を行う</a><ul><li><a href="#%E6%89%8B%E9%A0%86-21-%E6%9C%AA%E4%BD%9C%E6%88%90%E3%81%AE%E5%A0%B4%E5%90%88-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%99%BB%E9%8C%B2%E3%82%92%E8%A1%8C%E3%81%86">手順 2.1 (未作成の場合) アプリケーションの登録を行う</a></li><li><a href="#%E6%89%8B%E9%A0%86-22-%E8%AA%8D%E8%A8%BC%E3%81%AB%E3%81%A6%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">手順 2.2 認証にてアプリケーションを追加する</a></li><li><a href="#%E6%89%8B%E9%A0%86-23-%E3%83%95%E3%82%A7%E3%83%87%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%B3%87%E6%A0%BC%E6%83%85%E5%A0%B1%E3%81%AE%E8%A8%AD%E5%AE%9A">手順 2.3 フェデレーション資格情報の設定</a></li><li><a href="#%E6%89%8B%E9%A0%86-24-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B7%E3%83%BC%E3%82%AF%E3%83%AC%E3%83%83%E3%83%88%E3%81%AE%E4%B8%8A%E6%9B%B8%E3%81%8D">手順 2.4 クライアント シークレットの上書き</a></li></ul></li><li><a href="#%E6%89%8B%E9%A0%86-3-azure-data-factory-%E3%81%AE%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AB%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E4%BB%98%E4%B8%8E">手順 3 Azure Data Factory のマネージド ID にロールを付与</a></li><li><a href="#%E6%89%8B%E9%A0%86-4-azure-data-factory-%E3%81%AE-azure-%E9%96%A2%E6%95%B0-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3%E3%81%AE%E8%A8%AD%E5%AE%9A">手順 4 Azure Data Factory の Azure 関数 アクティビティの設定</a></li></ul></li></ul><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>この記事では、システム割り当てマネージド ID を使用して Azure Data Factory から Azure 関数を呼び出す方法について説明します。</p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2 Data Flow</li><li>Azure Functions </li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="手順-1-ユーザー割り当てマネージド-ID-を設定"><a href="#手順-1-ユーザー割り当てマネージド-ID-を設定" class="headerlink" title="手順 1 ユーザー割り当てマネージド ID を設定"></a>手順 1 ユーザー割り当てマネージド ID を設定</h2><p>ユーザー割り当てマネージド ID を、関数アプリの [ID] &gt; [ユーザー割り当て済み] より追加いたします。<br>公式ドキュメントの <a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-managed-identity?tabs=portal,http#add-a-user-assigned-identity">ユーザー割り当て ID を追加する</a> も併せてご確認ください。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-0.png"></p><p>Azure ポータルより、「エンタープライズ アプリケーション」と検索いただき、<br>ユーザー割り当てマネージド ID の「オブジェクト ID」 および 「アプリケーション ID」 を後述の設定にて用います。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-1.png"></p><h2 id="手順-2-Azure-関数の認証設定を行う"><a href="#手順-2-Azure-関数の認証設定を行う" class="headerlink" title="手順 2 Azure 関数の認証設定を行う"></a>手順 2 Azure 関数の認証設定を行う</h2><h3 id="手順-2-1-未作成の場合-アプリケーションの登録を行う"><a href="#手順-2-1-未作成の場合-アプリケーションの登録を行う" class="headerlink" title="手順 2.1 (未作成の場合) アプリケーションの登録を行う"></a>手順 2.1 (未作成の場合) アプリケーションの登録を行う</h3><p>Azure ポータルにて、[Microsoft Entra ID] と検索いただき、<br>[+ 追加] &gt; [アプリの登録] よりアプリの作成を行います。<br>名前を記載いただき、特別な理由がなければ規定値のまま進めます。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-2.png"><br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-3.png"></p><p>作成後に表示される「アプリケーション (クライアント) ID」 「オブジェクト ID」 「ディレクトリ (テナント) ID」をメモします。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-4.png"></p><h3 id="手順-2-2-認証にてアプリケーションを追加する"><a href="#手順-2-2-認証にてアプリケーションを追加する" class="headerlink" title="手順 2.2 認証にてアプリケーションを追加する"></a>手順 2.2 認証にてアプリケーションを追加する</h3><p>ご利用の Azure 関数の [認証] &gt; [ID プロバイダーを追加] を開きます。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-5.png"></p><p>以下画像のように設定いたします。<br>特筆すべき点を以下の表に記載しております。</p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>ID プロバイダー</td><td>Microsoft</td></tr><tr><td>アプリの登録</td><td>既存アプリの登録の詳細を提供します</td></tr><tr><td>アプリケーション (クライアント) ID</td><td>2.1 で作成したアプリのアプリケーション (クライアント) ID</td></tr><tr><td>Client application requiremen</td><td>「Allow requests from any application」もしくは 「Allow requests from specific client applications」</td></tr><tr><td>Allowed client applications (Allow requests from specific client applications を選択した場合)</td><td>Azure Data Factory のマネージド ID のアプリケーション (クライアント) ID</td></tr><tr><td>認証されていない要求</td><td>HTTP 401 認可されていない: API に推奨</td></tr></tbody></table><p><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-6.png"><br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-7.png"></p><h3 id="手順-2-3-フェデレーション資格情報の設定"><a href="#手順-2-3-フェデレーション資格情報の設定" class="headerlink" title="手順 2.3 フェデレーション資格情報の設定"></a>手順 2.3 フェデレーション資格情報の設定</h3><p>手順 2.1 で作成したアプリケーションの設定を行います。<br>Azure ポータルより、[アプリケーションの登録] から該当のアプリケーションを選択します。<br>[管理] &gt; [証明書とシークレット] &gt; [フェデレーション資格情報] から、「+ 資格情報の追加」を押下します。<br>そして、Azure Functions に割り当てたユーザー割り当てマネージド ID を選択します。  </p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>フェデレーション資格情報のシナリオ</td><td>カスタマー マネージド キー</td></tr><tr><td>マネージド ID の選択</td><td>手順 1 で割り当てたユーザー割り当てマネージド ID</td></tr></tbody></table><p><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-8.png"><br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-9.png"></p><p>PowerShell などから、az rest コマンドを用いて以下のように実行することも可能です。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az rest --method POST --uri &quot;https://graph.microsoft.com/beta/applications/&lt;APP_REGISTRATION_OBJECT_ID&gt;/federatedIdentityCredentials&quot; --body &quot;&#123;&#x27;name&#x27;: &#x27;ManagedIdentityFederation&#x27;, &#x27;issuer&#x27;: &#x27;https://login.microsoftonline.com/&lt;TENANT ID&gt;/v2.0&#x27;, &#x27;subject&#x27;: &#x27;&lt;AZURE_FUNCTION_USER_ASSIGNED_MANAGED_IDENTITY_OBJECT_ID&gt;&#x27;, &#x27;audiences&#x27;: [ &#x27;api://AzureADTokenExchange&#x27; ]&#125;&quot;</span><br></pre></td></tr></table></figure><h3 id="手順-2-4-クライアント-シークレットの上書き"><a href="#手順-2-4-クライアント-シークレットの上書き" class="headerlink" title="手順 2.4 クライアント シークレットの上書き"></a>手順 2.4 クライアント シークレットの上書き</h3><p>手順 2.2 で作成した ID プロバイダーにおける「クライアント シークレット設定の名前」を、ユーザー割り当てマネージド ID のクライアント ID に置き換えます。  </p><p>はじめに、該当の関数アプリより、[環境変数] &gt; [+ 追加] より、以下の設定を行い、[適用] を押下します。  </p><table><thead><tr><th>項目</th><th>値</th></tr></thead><tbody><tr><td>名前</td><td>OVERRIDE_USE_MI_FIC_ASSERTION_CLIENTID</td></tr><tr><td>値</td><td>手順 1 で割り当てたユーザー割り当てマネージド ID のクライアント ID</td></tr></tbody></table><p><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-10.png"></p><p>その後、[認証] &gt; [ID プロバイダー] より、該当の ID プロバイダーを編集を行います。<br>以下画像の通り、「クライアント シークレット設定の名前」に作成した環境変数を設定します。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-11.png"></p><h2 id="手順-3-Azure-Data-Factory-のマネージド-ID-にロールを付与"><a href="#手順-3-Azure-Data-Factory-のマネージド-ID-にロールを付与" class="headerlink" title="手順 3 Azure Data Factory のマネージド ID にロールを付与"></a>手順 3 Azure Data Factory のマネージド ID にロールを付与</h2><p>関数アプリの [アクセス制御 (IAM)] より、ご利用の Azure Data Factory のマネージド ID に対して<em>「閲覧者」ロール</em> を付与します。　</p><h2 id="手順-4-Azure-Data-Factory-の-Azure-関数-アクティビティの設定"><a href="#手順-4-Azure-Data-Factory-の-Azure-関数-アクティビティの設定" class="headerlink" title="手順 4 Azure Data Factory の Azure 関数 アクティビティの設定"></a>手順 4 Azure Data Factory の Azure 関数 アクティビティの設定</h2><p>Azure Data Factory Studio を開き、Azure 関数 アクティビティの設定を行います。<br>Azure 関数アクティビティをドラッグアンドドロップした後、[設定] &gt; [Azure 関数のリンク サービス] &gt; [+ 新規] を選択します。<br><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-12.png">  </p><p>接続先の関数アプリを選択いただき、[認証方法] を「システム割り当てマネージド ID」を選択し、[リソース ID] には手順 2.1 および手順 2.2 で登録したアプリケーションのクライアント ID を設定します。<br>詳細な設定項目につきましては、公式ドキュメントの <a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-azure-function-activity#azure-function-linked-service">Azure Functions のリンクされたサービス</a> もご覧ください。</p><p><img src="/blog/DataFactory/how-to-use-usai-auth4functions/how-to-use-usai4functions-13.png">  </p><p>以上の設定で完了です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%9B%AE%E6%AC%A1&quot;&gt;目次&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A6%82%E8%A6%81&quot;&gt;概要&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A4%9C%E8%A8%BC%E7%92%B0%E</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="Azure Functions" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure-Functions/"/>
    
    <category term="システム割り当てマネージドID" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89ID/"/>
    
  </entry>
  
  <entry>
    <title>Azure Data Factory を使用して SharePoint Online リストからデータをコピーする</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-connect-sp-online/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-connect-sp-online/</id>
    <published>2024-01-23T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.089Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>注意：<br><a href="#c-azure-data-factory-%E3%81%8B%E3%82%89-sharepoint-online-%E3%82%B5%E3%82%A4%E3%83%88%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AE%E6%BA%96%E5%82%99">C. Azure Data Factory から SharePoint Online サイトへの接続の準備</a>で説明されているSharePoint Online アプリのアクセス許可の機能はすでに廃止となっており、2026 年 4 月 2 日には完全に使用できなくなります。詳しくは以下のドキュメントをご覧ください（英語のみ）。<br><a href="https://learn.microsoft.com/en-us/sharepoint/dev/sp-add-ins/retirement-announcement-for-azure-acs">Azure ACS retirement in Microsoft 365 | Microsoft Learn</a></p></blockquote><!-- omit in toc --><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6">前提条件</a></li><li><a href="#%E5%8F%82%E8%80%83%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88">参考ドキュメント</a></li><li><a href="#a-microsoft-id-%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B">A. Microsoft ID プラットフォームにアプリケーションを登録する</a></li><li><a href="#b-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B7%E3%83%BC%E3%82%AF%E3%83%AC%E3%83%83%E3%83%88%E3%81%AE%E8%BF%BD%E5%8A%A0">B. アプリケーションのクライアントシークレットの追加</a></li><li><a href="#c-azure-data-factory-%E3%81%8B%E3%82%89-sharepoint-online-%E3%82%B5%E3%82%A4%E3%83%88%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AE%E6%BA%96%E5%82%99">C. Azure Data Factory から SharePoint Online サイトへの接続の準備</a></li><li><a href="#d-azure-data-factory-%E3%81%A7-sharepoint-online-%E3%83%AA%E3%82%B9%E3%83%88%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">D. Azure Data Factory で SharePoint Online リストへのリンク サービスを作成する</a></li><li><a href="#e-azure-data-factory-%E3%81%A7-sharepoint-online-%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">E. Azure Data Factory で SharePoint Online リストのデータセットを作成する</a></li><li><a href="#f-azure-data-factory-%E3%81%A7-blob-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">F. Azure Data Factory で Blob ストレージへのリンクサービスを作成する</a></li><li><a href="#g-azure-data-factory-%E3%81%A7%E3%82%B7%E3%83%B3%E3%82%AF%E3%81%AE-blob-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">G. Azure Data Factory でシンクの Blob ストレージのデータセットを作成する</a></li><li><a href="#h-azure-data-factory-%E3%81%A7-sharepoint-online-%E3%83%AA%E3%82%B9%E3%83%88%E3%81%8B%E3%82%89-blob-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%B8%E3%81%AE%E3%82%B3%E3%83%94%E3%83%BC-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">H. Azure Data Factory で SharePoint Online リストから Blob ストレージへのコピー アクティビティを作成する</a></li><li><a href="#i-%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%81%A8%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D">I. パイプラインの実行と結果の確認</a></li></ul><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ul><li>Azure Data Factory を作成済みであること。</li><li>ストレージ アカウントを作成済みであること。</li><li>SharePoint Online のリストを作成済みであること。</li></ul><h2 id="参考ドキュメント"><a href="#参考ドキュメント" class="headerlink" title="参考ドキュメント"></a>参考ドキュメント</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/data-factory/connector-sharepoint-online-list?tabs=data-factory">SharePoint Online リストからデータをコピーする - Azure Data Factory &amp; Azure Synapse | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/quickstart-register-app">クイック スタート: Microsoft ID プラットフォームでアプリを登録する - Microsoft identity platform | Microsoft Learn</a></li></ul><h2 id="A-Microsoft-ID-プラットフォームにアプリケーションを登録する"><a href="#A-Microsoft-ID-プラットフォームにアプリケーションを登録する" class="headerlink" title="A. Microsoft ID プラットフォームにアプリケーションを登録する"></a>A. Microsoft ID プラットフォームにアプリケーションを登録する</h2><p><strong>1) クラウド アプリケーション管理者の権限を持つユーザで、<a href="https://entra.microsoft.com/#home">Microsoft - Microsoft Entra 管理センター</a>にアクセスします</strong><br>複数のテナントにアクセスできる場合は、上部のメニューの [設定] アイコンを使い、<br>[ディレクトリとサブスクリプション] メニューから SharePoint Online が存在するテナントに切り替えます。<br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-1.png"></p><p><strong>2) [ID] &gt; [アプリケーション] &gt; [アプリの登録] に移動し、 [新規登録] を選びます</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-2.png"></p><p><strong>3) アプリケーションの表示名を入力します</strong><br>表示名はサインイン時など、アプリケーションのユーザーがアプリを使用するときに表示されることがあります。  表示名はいつでも変更できます。<br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-3.png"></p><p><strong>4) [サポートされているアカウントの種類] では SharePoint Online に接続できるユーザー（アプリケーションを含む）を指定します</strong><br>各項目の説明は <a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/quickstart-register-app#register-an-application">こちらのドキュメント</a>をご覧ください。<br>[リダイレクト URI (省略可能)] などその他の項目の入力は今回のケースでは不要です。<br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-4.png"></p><p><strong>5) [登録] をクリックして、アプリ登録を完了します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-5.png"></p><p>登録が完了すると、Microsoft Entra 管理センターにアプリの登録の [概要] ペインが表示されます。<br>[アプリケーション (クライアント) ID] の値を確認します。 この値は、”クライアント ID” とも呼ばれ、<br>Microsoft ID プラットフォーム内のアプリケーションを一意に識別します。</p><p><strong>6) この画面で表示される [アプリケーション（クライアント） ID] 、 [ディレクトリ（テナント） ID] をメモしておきます</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Entra-Setting-6.png"></p><h2 id="B-アプリケーションのクライアントシークレットの追加"><a href="#B-アプリケーションのクライアントシークレットの追加" class="headerlink" title="B. アプリケーションのクライアントシークレットの追加"></a>B. アプリケーションのクライアントシークレットの追加</h2><p><strong>1) 先ほどの画面から [証明書とシークレット] &gt; [クライアント シークレット] &gt; [新しいクライアント シークレット] を選択します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Client-Secret-1.png"></p><p><strong>2) クライアント シークレットの説明を追加します</strong><br>シークレットの有効期限を選択するか、カスタムの有効期間を指定します。<br>[追加] を選択します。<br><img src="/blog/DataFactory/how-to-connect-sp-online/Client-Secret-2.png"></p><p><strong>3) クライアント アプリケーションのコードで使用できるようにシークレットの値をコピーしておきます</strong><br>    <strong>このページから離れるとこのシークレットの値は 二度と表示されません。</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Client-Secret-3.png"></p><h2 id="C-Azure-Data-Factory-から-SharePoint-Online-サイトへの接続の準備"><a href="#C-Azure-Data-Factory-から-SharePoint-Online-サイトへの接続の準備" class="headerlink" title="C. Azure Data Factory から SharePoint Online サイトへの接続の準備"></a>C. Azure Data Factory から SharePoint Online サイトへの接続の準備</h2><p><strong>1) 接続先の SharePoint Online でアクセス許可を設定します</strong><br>https://[your_site_url]/_layouts/15/appinv.aspx を開きます。<br>([your_site_url] の部分はお使いの SharePoint Online の URL に置き換えてください。)</p><p>先ほどの手順でメモしたアプリケーション ID を空欄に入力します。<br>[参照] をクリックすると設定した SharePoint Online の表示名が自動で入力されます。<br>その他の項目は以下のように入力します。</p><table><thead><tr><th align="left">設定項目</th><th align="left">入力内容</th></tr></thead><tbody><tr><td align="left">アプリドメイン</td><td align="left">localhost.com （今回のケースではダミーを使用します）</td></tr><tr><td align="left">リダイレクト URL</td><td align="left"><a href="https://www.localhost.com/">https://www.localhost.com</a>（今回のケースではダミーを使用します）</td></tr></tbody></table><p>権限の要求 XML には以下の内容をコピー &amp; ペーストで入力します。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">AppPermissionRequests</span> <span class="attr">AllowAppOnlyPolicy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AppPermissionRequest</span> <span class="attr">Scope</span>=<span class="string">&quot;http://sharepoint/content/sitecollection/web&quot;</span> <span class="attr">Right</span>=<span class="string">&quot;Read&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">AppPermissionRequests</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>2) [作成] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/SharePoint-Access-1.png"></p><p><strong>3) [信頼する] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/SharePoint-Access-2.png"></p><h2 id="D-Azure-Data-Factory-で-SharePoint-Online-リストへのリンク-サービスを作成する"><a href="#D-Azure-Data-Factory-で-SharePoint-Online-リストへのリンク-サービスを作成する" class="headerlink" title="D. Azure Data Factory で SharePoint Online リストへのリンク サービスを作成する"></a>D. Azure Data Factory で SharePoint Online リストへのリンク サービスを作成する</h2><p><strong>1) Azure Data Factory の [管理] メニューに移動し、 [リンク サービス] を選択して、 [新規] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-1.png"></p><p><strong>2) SharePoint を検索し、[SharePoint Online リスト] コネクタを選択します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-2.png"></p><p><strong>3) 入力フィールドに情報を入力して、テスト接続を行います</strong><br>サイト URL には接続対象の SharePoint Online の URL を入力します。<br>テナント ID、サービスプリンシパル ID、サービスプリンシパル キーには前の手順で登録した<br>テナント ID、アプリケーション ID、シークレット値をそれぞれ記入します。<br>入力が済んだら [テスト接続] をクリックして、 SharePoint Online との接続を確認します。<br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-3.png"></p><p>接続が成功したら [適用] をクリックしてリンク サービスを作成します。</p><h2 id="E-Azure-Data-Factory-で-SharePoint-Online-リストのデータセットを作成する"><a href="#E-Azure-Data-Factory-で-SharePoint-Online-リストのデータセットを作成する" class="headerlink" title="E. Azure Data Factory で SharePoint Online リストのデータセットを作成する"></a>E. Azure Data Factory で SharePoint Online リストのデータセットを作成する</h2><p><strong>1) [作成者] アイコン &gt; [データセット] &gt; […] メニュー &gt; [新しいデータセット] から接続先（SharePoint）のデータセットを作成します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-4.png"></p><p><strong>2) [SharePoint Online リスト] を選択して、[続行] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-5.png"></p><p><strong>3) 入力フィールドに必要な情報を入力して [OK] を選択します</strong><br>任意の名前を入力し、先ほどの手順で作成したリンクサービスを選択します。<br>さらにコピー対象となる SharePoint Online のリスト名を選択して [OK] をクリックします。<br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-6.png"></p><h2 id="F-Azure-Data-Factory-で-Blob-ストレージへのリンクサービスを作成する"><a href="#F-Azure-Data-Factory-で-Blob-ストレージへのリンクサービスを作成する" class="headerlink" title="F. Azure Data Factory で Blob ストレージへのリンクサービスを作成する"></a>F. Azure Data Factory で Blob ストレージへのリンクサービスを作成する</h2><blockquote><p>今回の例では出力先を Azure BLOB ストレージの任意のディレクトリとします。<br>ストレージの作成方法等については、[ストレージ アカウントを作成する] (<a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-create?tabs=azure-portal)%E3%82%92%E3%81%94%E8%A6%A7%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-create?tabs=azure-portal)をご覧ください。</a></p></blockquote><p><strong>1) Azure Data Factory の [管理] タブに移動し、[リンク サービス] を選択して、 [新規] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-7.png"></p><p><strong>2) Azure BLOB ストレージを選択し、[続行] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-8.png"></p><p><strong>3) 必要な情報を入力し、テスト接続ができることを確認します</strong><br>任意の名前を入力し、出力先となるストレージ アカウントを選択します。<br>テスト接続を行い、成功したら、[作成] をクリックします。<br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-9.png"></p><h2 id="G-Azure-Data-Factory-でシンクの-Blob-ストレージのデータセットを作成する"><a href="#G-Azure-Data-Factory-でシンクの-Blob-ストレージのデータセットを作成する" class="headerlink" title="G. Azure Data Factory でシンクの Blob ストレージのデータセットを作成する"></a>G. Azure Data Factory でシンクの Blob ストレージのデータセットを作成する</h2><p><strong>1) [作成者] アイコン &gt; データセット右の […] メニュー &gt; 新しいデータセットから接続先のデータセットを作成します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-10.png"></p><p><strong>2) Azure Blob ストレージを選択して、 [続行] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-11.png"></p><p><strong>3) 出力形式は “DelimitedText” を選択して、 [続行] をクリックします</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-12.png"></p><p><strong>4) 必要な情報を入力し、データセットを作成します</strong><br>任意の名前を入力し、先の手順で作成したリンク サービスを選びます。<br>ファイルパスは任意の Blob ストレージのパスを入力します。<br>[先頭行をヘッダーとして] のチェックはそのままで [OK] をクリックします。<br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-13.png"></p><h2 id="H-Azure-Data-Factory-で-SharePoint-Online-リストから-Blob-ストレージへのコピー-アクティビティを作成する"><a href="#H-Azure-Data-Factory-で-SharePoint-Online-リストから-Blob-ストレージへのコピー-アクティビティを作成する" class="headerlink" title="H. Azure Data Factory で SharePoint Online リストから Blob ストレージへのコピー アクティビティを作成する"></a>H. Azure Data Factory で SharePoint Online リストから Blob ストレージへのコピー アクティビティを作成する</h2><p><strong>1) 新規にパイプラインを作成し、アクティビティの [移動と変換] から [データのコピー] アクティビティを選び、キャンバスにドラッグ &amp; ドロップで配置します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-14.png"></p><p><strong>2) ソース タブで先ほど作成した、SharePoint Online のデータセットを選びます</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-15.png"></p><p><strong>3) 次にシンク タブで先ほど作成した Blob ストレージのデータセットを選びます</strong><br>また、必要に応じて他の項目も設定します。<br><img src="/blog/DataFactory/how-to-connect-sp-online/ADF-Setting-16.png"></p><h2 id="I-パイプラインの実行と結果の確認"><a href="#I-パイプラインの実行と結果の確認" class="headerlink" title="I. パイプラインの実行と結果の確認"></a>I. パイプラインの実行と結果の確認</h2><p><strong>1) 上記の設定が完了したら、[トリガーの追加] &gt; [今すぐトリガー] で実行します</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Pipeline-Result-1.png"></p><p><strong>2) 画面一番左の [モニター] メニューの [パイプライン実行] で先ほどトリガー実行したパイプラインの結果を確認することが可能です</strong><br><img src="/blog/DataFactory/how-to-connect-sp-online/Pipeline-Result-2.png"></p><p>また、シンクの Blob ストレージで出力されたファイルを確認することも可能です。<br><img src="/blog/DataFactory/how-to-connect-sp-online/Pipeline-Result-3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;注意：&lt;br&gt;&lt;a href=&quot;#c-azure-data-factory-%E3%81%8B%E3%82%89-sharepoint-online-%E3%82%B5%E3%82%A4%E3%83%88%E3%81%B8%E3%81%AE%E6%</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="SharePoint Online" scheme="https://jpaz-bigdata.github.io/blog/tags/SharePoint-Online/"/>
    
    <category term="SharePoint Online リスト" scheme="https://jpaz-bigdata.github.io/blog/tags/SharePoint-Online-%E3%83%AA%E3%82%B9%E3%83%88/"/>
    
  </entry>
  
  <entry>
    <title>シンクに出力するファイル名に日付やパイプライン実行 ID を加える方法</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/</id>
    <published>2023-06-22T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.084Z</updated>
    
    <content type="html"><![CDATA[<p>シンクにデータを格納する際のファイル名に、実行時の日付やパイプライン実行 ID を加える方法をご紹介いたします。<br>ファイル名を操作するために、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-expression-language-functions#date-functions">データ関数</a> や <a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-system-variables">システム変数</a> と <a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-expression-language-functions#concat">concat 関数</a> を用いた文字列結合を行うことで実現できます。  </p><p>また、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-expression-language-functions#complex-expression-example">公式ドキュメントの複合式の例</a> も併せてご確認ください。</p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2</li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="日付をファイル名に含める場合"><a href="#日付をファイル名に含める場合" class="headerlink" title="日付をファイル名に含める場合"></a>日付をファイル名に含める場合</h2><p>実行時における日付といった動的なコンテンツを追加するために、今回は [パイプライン式ビルダー] を用います。<br>[Datasets] の [ファイルパス] より、[動的なコンテンツの追加] を選択し、[パイプライン式ビルダー] を開きます。</p><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/date-setting-1.png">   </p><p>実行時のタイムスタンプを得るためには、データ関数の <code>utcnow()</code> を使うことで実現できます。また、パイプラインを呼び出したトリガーの実行時刻が必要な場合は、<code>@pipeline().TriggerTime</code> を使うことで実現が可能です。<br>今回は、下記の複合式を用いました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@concat(&#x27;Test-&#x27;, formatDateTime(utcnow(), &#x27;yyyy-MM-dd&#x27;), &#x27;.csv&#x27;)</span><br></pre></td></tr></table></figure><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/date-setting-2.png">   </p><p>下記が実行結果となります。設定したシンクである Azure Blob Storage 上のファイル名に日付の情報が含まれていることが確認いただけます。</p><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/date-result-1.png"> </p><h2 id="パイプライン実行-ID-をファイル名に加える場合"><a href="#パイプライン実行-ID-をファイル名に加える場合" class="headerlink" title="パイプライン実行 ID をファイル名に加える場合"></a>パイプライン実行 ID をファイル名に加える場合</h2><p>同様に、[ファイルパス] より [パイプライン式ビルダー] を開きます。パイプラインの実行 ID を取得するには、システム変数の一つである <code>pipeline().RunId</code> を使うことで実現できます。<br>その他にも、ワークスペースの名前やパイプラインの名前を取得することも可能でございます。詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/control-flow-system-variables">システム変数</a> をご覧ください。  </p><p>今回は、下記の複合式を用いました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@concat(&#x27;Test-&#x27;, pipeline().RunId, &#x27;.csv&#x27;)</span><br></pre></td></tr></table></figure><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/runid-setting-1.png">   </p><p>下記が実行結果となります。確かに、パイプラインの実行 ID がシンクである Azure Blob Storage 上のファイル名に含まれていることが確認できます。</p><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/runid-result-1.png"><br><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/runid-result-2.png">   </p><h2 id="パイプラインの変数からファイル名を渡す場合"><a href="#パイプラインの変数からファイル名を渡す場合" class="headerlink" title="パイプラインの変数からファイル名を渡す場合"></a>パイプラインの変数からファイル名を渡す場合</h2><p>これまでは、Datasets のファイルパスに書き込む形で実現していましたが、アクティビティの設定から指定する方法で実行します。<br>流れとしては、Datasets のパラメータを作成した後、ファイルパスに作成したパラメータを指定します。Datasets のパラメータに対して、アクティビティの設定から、所望の複合式を渡します。その際に、変数として設定しておく方法をご紹介いたします。</p><p>まず、[Datasets] の [パラメータ] から任意のパラメータを作成します。[規定値] は、空のままとします。</p><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/variable-setting-1.png"></p><p>[ファイルパス] の  [パイプライン式ビルダー] では、作成したパラメータを指定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@dataset().filename</span><br></pre></td></tr></table></figure><p>パイプライン キャンパスの背景を選び、[変数] タブを選択して、変数を追加します。</p><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/variable-setting-2.png"></p><p>アクティビティを選択し、[シンク] タブより、[シンク データセット] の [データセットのプロパティ] の [値] に、先ほど設定した変数を記入します。変数を呼びだすためには、下記のように <code>variables()</code> を用います。<br>以上の操作で、シンクに出力されるファイル名に日付を加えることが可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@variables(&#x27;filename&#x27;)</span><br></pre></td></tr></table></figure><p><img src="/blog/DataFactory/how-to-add-variables-to-sink-filename-in-copy-activity/variable-setting-3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;シンクにデータを格納する際のファイル名に、実行時の日付やパイプライン実行 ID を加える方法をご紹介いたします。&lt;br&gt;ファイル名を操作するために、&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/data-factory/c</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="システム変数" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%A4%89%E6%95%B0/"/>
    
    <category term="データ関数" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%83%87%E3%83%BC%E3%82%BF%E9%96%A2%E6%95%B0/"/>
    
  </entry>
  
  <entry>
    <title>サービスプリンシパル認証によるAzure Data Factory と Dynamics 365 (Microsoft Dataverse) の接続方法</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/</id>
    <published>2023-06-19T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.097Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83">検証環境</a></li><li><a href="#%E6%89%8B%E9%A0%86">手順</a><ul><li><a href="#dataverse-%E5%81%B4%E3%81%AE%E6%8E%A5%E7%B6%9A%E6%A8%A9%E9%99%90%E4%BB%98%E4%B8%8E">Dataverse 側の接続権限付与</a></li><li><a href="#data-factory-%E5%81%B4%E3%81%AE%E6%8E%A5%E7%B6%9A%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97-%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90">Data Factory 側の接続情報取得 (リンクサービスの作成)</a></li></ul></li></ul><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>サービスプリンシパル認証を使った Data Factory と Dataverse  のリンクサービスの作成方法についてご紹介いたします。作成するにあたり、Dataverse に紐づくアプリケーションに関する情報の取得と Dataverse 側でのアクセス権限の付与が必要になります。<br><a href="https://learn.microsoft.com/ja-jp/azure/data-factory/connector-dynamics-crm-office-365?tabs=data-factory">Dataverse コネクタの公式ドキュメント</a> も併せてご確認ください。  </p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2</li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="Dataverse-側の接続権限付与"><a href="#Dataverse-側の接続権限付与" class="headerlink" title="Dataverse 側の接続権限付与"></a>Dataverse 側の接続権限付与</h2><p>Azure AD 登録済みアプリケーションから Dataverse にアクセスするには Office 365 側の アプリ ユーザーが必要です。<br><a href="https://learn.microsoft.com/ja-jp/power-platform/admin/manage-application-users#create-an-application-user">Power Platform 管理センターでアプリケーション ユーザーを管理する</a> も併せてご確認ください。 </p><p>以下の手順で新しいアプリ ユーザーを作成します。   </p><p><a href="https://admin.powerplatform.microsoft.com/home">Power Platform 管理センター</a> にシステム管理者でアクセスします。<br>[環境] から該当する環境を選択します。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/power-platform-1.png"></p><p>環境 URL を取得しておきます。Azure Data Factory のリンクサービスを作る際の、サービス URL の一部になります。<br>[設定] を選択します。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/power-platform-2.png"></p><p> [ユーザーとアクセス許可] を選択してから、[アプリケーション ユーザー] を選択します。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/power-platform-3.png"></p><p> [+ 新規アプリ ユーザー] を選択し、新しいアプリ ユーザーの作成ページを開きます。<br> [部署] で、ドロップダウン リストから部署を選択した後、 [セキュリティ ロール] の [編集] を選択します。<br> 新しいアプリケーション ユーザーに追加する、選択した部署におけるセキュリティ ロールを選択できます。[システム管理者] などのセキュリティ ロールを追加した後、[保存] を選択します。</p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/power-platform-4.png"></p><h2 id="Data-Factory-側の接続情報取得-リンクサービスの作成"><a href="#Data-Factory-側の接続情報取得-リンクサービスの作成" class="headerlink" title="Data Factory 側の接続情報取得 (リンクサービスの作成)"></a>Data Factory 側の接続情報取得 (リンクサービスの作成)</h2><p>Azure AD 登録されているアプリケーションの情報を取得する必要があります。<br>Azure Portal より [アプリの登録] から確認できます。  </p><p>[!TIP]<br>Azure AD にアプリケーションが登録されていない、もしくは、新たに登録が必要な場合は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/howto-create-service-principal-portal#register-an-application-with-azure-ad-and-create-a-service-principal">リソースにアクセスできる Azure Active Directory アプリケーションとサービス プリンシパルを作成する</a> を参考にご登録ください。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/linked-service-1.png"></p><p>サービスプリンシパル認証に必要な ID とキーを取得します。<br>サービスプリンシパル ID は、[アプリ情報] -&gt; [概要] -&gt; [アプリケーションID] で取得できます。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/linked-service-service-principal-id.png"></p><p>サービスプリンシパル キー は、[アプリ情報] -&gt; [証明書とシークレット] -&gt; [クライアントシークレット] で取得もしくは作成できます。  </p><p>[!IMPORTANT]<br>作成直後を除き、クライアント シークレットの値を後から確認できません。ページを終了する前に、必ず保存してください。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/linked-service-service-principal-key.png"></p><p>得られた情報から、Azure Data Factory 上でリンクサービスの作成を行います。サービスURI は、Power Platform 管理センター で得られた環境URL を用います。必要に応じて、https://  などを加えてください。  </p><p><img src="/blog/DataFactory/how-to-create-dataverse-linkedservice-by-service-principal/linked-service-service.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%9B%AE%E6%AC%A1&quot;&gt;目次&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A6%82%E8%A6%81&quot;&gt;概要&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A4%9C%E8%A8%BC%E7%92%B0%E</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="Dataverse" scheme="https://jpaz-bigdata.github.io/blog/tags/Dataverse/"/>
    
    <category term="リンクサービス" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>Data Flowの外部呼び出し変換方法の参考例</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-data-flow-external-call/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-data-flow-external-call/</id>
    <published>2023-06-05T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.102Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83">検証環境</a></li><li><a href="#%E6%89%8B%E9%A0%86">手順</a><ul><li><a href="#rest-api-%E3%81%AE%E6%BA%96%E5%82%99">REST API の準備</a></li><li><a href="#data-flow-%E3%81%AE%E6%BA%96%E5%82%99">Data Flow の準備</a></li><li><a href="#%E5%A4%96%E9%83%A8%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E8%A8%AD%E5%AE%9A">外部呼び出しの設定</a><ul><li><a href="#rest-%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90">REST のリンクサービスの作成</a></li><li><a href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E5%A4%89%E6%8F%9B%E3%81%AE%E8%A8%AD%E5%AE%9A">呼び出し変換の設定</a></li><li><a href="#mapping-%E3%81%AE%E8%A8%AD%E5%AE%9A">Mapping の設定</a></li><li><a href="#output-%E3%81%AE%E8%A8%AD%E5%AE%9A">Output の設定</a></li></ul></li><li><a href="#%E5%A4%96%E9%83%A8%E5%91%BC%E3%81%B6%E5%87%BA%E3%81%97%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D">外部呼ぶ出しの実行結果の確認</a></li></ul></li><li><a href="#%E3%81%94%E7%B4%B9%E4%BB%8B%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E6%A9%9F%E8%83%BD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">ご紹介していない機能について</a><ul><li><a href="#%E8%A1%8C%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E9%81%A9%E7%94%A8%E3%81%99%E3%82%8Bapi-%E3%82%92%E5%A4%89%E3%81%88%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D">行によって適用するAPI を変えたいとき</a></li><li><a href="#response-%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E5%8A%A0%E3%81%88%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D">Response をデータに加えたいとき</a></li></ul></li></ul><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>Data Flowにおける外部呼び出し変換を使用すると、外部のREST API を行単位で適用することが可能です。<br>この記事では、投稿日時点での機能を用いて、外部呼び出しの使用例をご紹介します。<br><a href="https://learn.microsoft.com/ja-jp/azure/data-factory/data-flow-external-call">外部呼び出しの公式ドキュメント</a> も併せてご確認ください。<br>この記事では、一枚目にあるデータの各行のデータをbody として、外部のAPI にPOST します。最後に、その他の例についても簡単にはなりますが、記載いたします。</p><p>POST する前のデータ<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-about-1.png">    </p><p>POST した後のデータ<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-about-2.png"></p><p>一行目の id=7065 の行をbody としてPOST した結果<br><code>&#123;&#39;id&#39;: 7065, &#39;title&#39;: &#39;Birth of a Nation, The&#39;, &#39;year&#39;: 1915, &#39;Rating&#39;: 6&#125;</code><br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-about-3.png"></p><h1 id="検証環境"><a href="#検証環境" class="headerlink" title="検証環境"></a>検証環境</h1><ul><li>Azure Data Factory V2 Data Flow</li><li>Azure Functions (REST API用)</li></ul><h1 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h1><h2 id="REST-API-の準備"><a href="#REST-API-の準備" class="headerlink" title="REST API の準備"></a>REST API の準備</h2><p>Data Flow から外部呼び出しを行うAPI の準備をします。<br>Azure Functions を用いて、Data Flow から外部呼び出しどのように行われているか確認するため、受け取ったリクエストをログに吐き出すだけのAPI を作成します。  </p><p>ここでは、下記のようなpython での関数で検証を行います。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">import azure.functions as func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main(req: func.HttpRequest) -&gt; func.HttpResponse:</span><br><span class="line">    logging.info(&#x27;Python HTTP trigger function processed a request.&#x27;)</span><br><span class="line">    logging.info(req)</span><br><span class="line">    logging.info(req.get_json())  # bodyの内容をログに吐き出す</span><br><span class="line">    logging.info(req.params)</span><br><span class="line">    </span><br><span class="line">    req_body = req.get_json()</span><br><span class="line">    movie_id = req_body.get(&#x27;id&#x27;)</span><br><span class="line">    logging.info(f&quot;movie&#x27;s id is &#123;movie_id&#125;&quot;)</span><br><span class="line">    return func.HttpResponse(</span><br><span class="line">            &quot;This HTTP triggered function executed successfully. &quot;,</span><br><span class="line">            status_code=200)</span><br></pre></td></tr></table></figure><p>保存を行い、関数URL の取得を行います。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/azurefunctions-1.png">  </p><h2 id="Data-Flow-の準備"><a href="#Data-Flow-の準備" class="headerlink" title="Data Flow の準備"></a>Data Flow の準備</h2><p>外部呼び出しを含むData Flow を作成しました。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-1.png">  </p><p>外部呼び出しは、スキーマ修飾子 の中にあります。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-2.png">  </p><h2 id="外部呼び出しの設定"><a href="#外部呼び出しの設定" class="headerlink" title="外部呼び出しの設定"></a>外部呼び出しの設定</h2><h3 id="REST-のリンクサービスの作成"><a href="#REST-のリンクサービスの作成" class="headerlink" title="REST のリンクサービスの作成"></a>REST のリンクサービスの作成</h3><p>ベースURL に、Azure Functions で取得したURLを入れ、接続を行います。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-3.png">  </p><h3 id="呼び出し変換の設定"><a href="#呼び出し変換の設定" class="headerlink" title="呼び出し変換の設定"></a>呼び出し変換の設定</h3><p>API をたたく際のリンクサービスやヘッダー、API のカスタマイズ等を行います。<br>本検証では各項目を以下のとおり設定しております。実行する API に応じて適宜設定いただきますようお願い致します。<br>現時点では、REST のみがサポートされています。</p><p>要求メソッド：POST<br>要求書式：JSON<br>要求JSON設定：未設定<br>応答書式：JSON<br>応答JSON設定：単一のドキュメント</p><p><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-4.png">  </p><h3 id="Mapping-の設定"><a href="#Mapping-の設定" class="headerlink" title="Mapping の設定"></a>Mapping の設定</h3><p>ここでは、bodyに関する設定を行います。bodyに含めたい列とkey名を指定します。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-5.png">  </p><h3 id="Output-の設定"><a href="#Output-の設定" class="headerlink" title="Output の設定"></a>Output の設定</h3><p>POST したResponse に関して設定を行います。<br>今回は、POST が成功したかどうかの状態のみを設定します。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-6.png">  </p><h2 id="外部呼ぶ出しの実行結果の確認"><a href="#外部呼ぶ出しの実行結果の確認" class="headerlink" title="外部呼ぶ出しの実行結果の確認"></a>外部呼ぶ出しの実行結果の確認</h2><p>下記のように、データのプレビューから、最新の情報に更新を行うことで、実際にPOST をして結果を確認できます。status が200番が帰っており、API を正常に叩けていることが確認できました。  </p><p><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-result-1.png"> </p><p>Azure Functions 側のログから、どのようにリクエストが飛んできたか確認できます。<br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-about-3.png"></p><h1 id="ご紹介していない機能について"><a href="#ご紹介していない機能について" class="headerlink" title="ご紹介していない機能について"></a>ご紹介していない機能について</h1><p>上記のサンプルでは、使用していない項目についてご紹介します。<br>英語にはなりますが、詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/data-flow-external-call">外部呼び出しの公式ドキュメント</a> にございます動画をご覧ください。</p><h2 id="行によって適用するAPI-を変えたいとき"><a href="#行によって適用するAPI-を変えたいとき" class="headerlink" title="行によって適用するAPI を変えたいとき"></a>行によって適用するAPI を変えたいとき</h2><p>公式ドキュメントの動画内にあるとおり、呼び出し変換の設定 -&gt; 行の相対URL に対象の列を指定することで解決できます。<br>動画では、派生列変換を用いて、リンクサービスで指定したベースURL に続く相対URL のための列(ziplookup)を生成しております。<br>その後、外部呼び出し変換の行の相対URL にて列をしてしております。</p><p><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-tips-1.png"><br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-tips-2.png"> </p><h2 id="Response-をデータに加えたいとき"><a href="#Response-をデータに加えたいとき" class="headerlink" title="Response をデータに加えたいとき"></a>Response をデータに加えたいとき</h2><p>API のResponse をデータフローのデータの中に含めたい場合は、上述のOutPut の設定を行います。本文にチェックボックスを加えて、Response のkey名と型についての定義が必要です。</p><p><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-tips-3.png"><br><img src="/blog/DataFactory/how-to-data-flow-external-call/dataflow-tips-4.png"> </p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%9B%AE%E6%AC%A1&quot;&gt;目次&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A6%82%E8%A6%81&quot;&gt;概要&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A4%9C%E8%A8%BC%E7%92%B0%E</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="data flow" scheme="https://jpaz-bigdata.github.io/blog/tags/data-flow/"/>
    
    <category term="外部呼び出し" scheme="https://jpaz-bigdata.github.io/blog/tags/%E5%A4%96%E9%83%A8%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97/"/>
    
    <category term="external-call" scheme="https://jpaz-bigdata.github.io/blog/tags/external-call/"/>
    
  </entry>
  
  <entry>
    <title>Azure Data Factory のサポートファイルの取得方法</title>
    <link href="https://jpaz-bigdata.github.io/blog/DataFactory/how-to-get-adf-support-file/"/>
    <id>https://jpaz-bigdata.github.io/blog/DataFactory/how-to-get-adf-support-file/</id>
    <published>2023-05-23T00:00:00.000Z</published>
    <updated>2025-01-30T09:32:33.108Z</updated>
    
    <content type="html"><![CDATA[<p>課題解決に向けて、弊社の担当からサポートファイルのご提供をお願いすることがあります。<br>サポートファイルを取得するためには、Azure Data Factory Studio のパイプライン編集画面から取得できます。</p><p><img src="/blog/DataFactory/how-to-get-adf-support-file/how-to-get-adf-support-file-1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;課題解決に向けて、弊社の担当からサポートファイルのご提供をお願いすることがあります。&lt;br&gt;サポートファイルを取得するためには、Azure Data Factory Studio のパイプライン編集画面から取得できます。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/Dat</summary>
      
    
    
    
    
    <category term="Azure" scheme="https://jpaz-bigdata.github.io/blog/tags/Azure/"/>
    
    <category term="Data Factory" scheme="https://jpaz-bigdata.github.io/blog/tags/Data-Factory/"/>
    
    <category term="サポートファイル" scheme="https://jpaz-bigdata.github.io/blog/tags/%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB/"/>
    
  </entry>
  
</feed>
